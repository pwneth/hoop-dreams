import fs from 'fs';
import path from 'path';

/**
 * generate-apps-script.js
 * 
 * Standalone generator for the Google Apps Script backend.
 * Provides the full Apps Script logic as a template while requiring custom admin credentials.
 */

const args = process.argv.slice(2);
const adminUsername = args[0];
const adminPassword = args[1];

if (!adminUsername || !adminPassword) {
    console.error('Error: Admin username and password are required.');
    console.error('Usage: node generate-apps-script.js <admin_username> <admin_password>');
    process.exit(1);
}

const outputDir = path.resolve('google-apps-script');
const outputPath = path.join(outputDir, 'Code.gs');

if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
}

const lines = [
    "/**",
    " * Google Apps Script - HD Bets API",
    " * ",
    " * SETUP INSTRUCTIONS:",
    " * 1. Open Google Sheets",
    " * 2. Go to Extensions > Apps Script",
    " * 3. Delete any existing code and paste this entire file",
    " * 4. Run the 'setup' function once to initialize",
    " * 5. Click Deploy > New deployment > Web app > Execute as: Me > Who has access: Anyone",
    " * 6. Copy URL to your local .env file as VITE_APPS_SCRIPT_URL",
    " */",
    "",
    "const SHEET_BETS = 'Bets';",
    "const SHEET_USERS = 'Users';",
    "",
    "/**",
    " * Setup function - RUN THIS ONCE to initialize Users sheet",
    " */",
    "function setup() {",
    "  const ss = SpreadsheetApp.getActiveSpreadsheet();",
    "  let usersSheet = ss.getSheetByName(SHEET_USERS);",
    "  ",
    "  if (!usersSheet) {",
    "    usersSheet = ss.insertSheet(SHEET_USERS);",
    "    // Headers",
    "    usersSheet.appendRow(['Username', 'Password', 'IsAdmin']);",
    "    ",
    "    // Seed Users",
    "    const initialUsers = [",
    "      ['" + adminUsername + "', '" + adminPassword + "', true]",
    "    ];",
    "    ",
    "    initialUsers.forEach(user => {",
    "      const hashedPassword = hashPassword(user[1]);",
    "      usersSheet.appendRow([user[0], hashedPassword, user[2]]);",
    "    });",
    "  }",
    "}",
    "",
    "function hashPassword(password) {",
    "  const rawHash = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, password);",
    "  let txtHash = '';",
    "  for (let i = 0; i < rawHash.length; i++) {",
    "    let hashVal = rawHash[i];",
    "    if (hashVal < 0) {",
    "      hashVal += 256;",
    "    }",
    "    if (hashVal.toString(16).length == 1) {",
    "      txtHash += '0';",
    "    }",
    "    txtHash += hashVal.toString(16);",
    "  }",
    "  return txtHash;",
    "}",
    "",
    "/**",
    " * Handle GET requests",
    " */",
    "function doGet(e) {",
    "  return handleRequest(e);",
    "}",
    "",
    "/**",
    " * Handle POST requests",
    " */",
    "function doPost(e) {",
    "  return handleRequest(e);",
    "}",
    "",
    "function handleRequest(e) {",
    "  try {",
    "    const params = e.parameter || {};",
    "    // Handle POST body if present",
    "    if (e.postData && e.postData.contents) {",
    "      try {",
    "        const body = JSON.parse(e.postData.contents);",
    "        Object.assign(params, body);",
    "      } catch (err) {",
    "        // ignore",
    "      }",
    "    }",
    "",
    "    const action = params.action;",
    "",
    "    if (action === 'login') {",
    "      return loginUser(params.username, params.password);",
    "    }",
    "    ",
    "    if (action === 'register') {",
    "      return registerUser(params.username, params.password);",
    "    }",
    "",
    "    if (action === 'changePassword') {",
    "      return changePassword(params.username, params.oldPassword, params.newPassword);",
    "    }",
    "    ",
    "    // Authenticate validation for other actions",
    "    const user = authenticate(params.username, params.password);",
    "    if (!user) {",
    "      return createResponse({ success: false, error: 'Authentication failed' });",
    "    }",
    "",
    "    const ss = SpreadsheetApp.getActiveSpreadsheet();",
    "    const sheet = ss.getSheetByName(SHEET_BETS) || ss.getSheets()[0];",
    "",
    "    if (action === 'getBets') {",
    "      return getBets(sheet);",
    "    }",
    "    ",
    "    if (action === 'addBet') {",
    "      return addBet(sheet, params, user);",
    "    }",
    "",
    "    if (action === 'updateBet') {",
    "      return updateBet(sheet, params, user);",
    "    }",
    "",
    "    if (action === 'confirmBet') {",
    "      return confirmBet(sheet, params, user);",
    "    }",
    "",
    "    if (action === 'markPaid') {",
    "      return markPaid(sheet, params, user);",
    "    }",
    "",
    "    if (action === 'getUsers') {",
    "      return getUsers();",
    "    }",
    "    ",
    "    // Default to getBets if no action (backward compatibility-ish)",
    "    return getBets(sheet);",
    "    ",
    "  } catch (error) {",
    "    return createResponse({ success: false, error: error.message });",
    "  }",
    "}",
    "",
    "function authenticate(username, password) {",
    "  if (!username || !password) return null;",
    "  const ss = SpreadsheetApp.getActiveSpreadsheet();",
    "  const usersSheet = ss.getSheetByName(SHEET_USERS);",
    "  if (!usersSheet) return null;",
    "  ",
    "  const data = usersSheet.getDataRange().getValues();",
    "  // Skip header",
    "  for (let i = 1; i < data.length; i++) {",
    "    const row = data[i];",
    "    if (row[0].toLowerCase() === username.toLowerCase()) {",
    "      const hashedPassword = hashPassword(password);",
    "      if (row[1] === hashedPassword) {",
    "        return { username: row[0], isAdmin: row[2] === true || row[2] === 'true' };",
    "      }",
    "    }",
    "  }",
    "  return null;",
    "}",
    "",
    "function loginUser(username, password) {",
    "  const user = authenticate(username, password);",
    "  if (user) {",
    "    return createResponse({ success: true, user: user });",
    "  }",
    "  return createResponse({ success: false, error: 'Invalid username or password' });",
    "}",
    "",
    "function registerUser(username, password) {",
    "  const ss = SpreadsheetApp.getActiveSpreadsheet();",
    "  let usersSheet = ss.getSheetByName(SHEET_USERS);",
    "  if (!usersSheet) return createResponse({ success: false, error: 'System not initialized' });",
    "  ",
    "  // Check existing",
    "  const data = usersSheet.getDataRange().getValues();",
    "  for (let i = 1; i < data.length; i++) {",
    "    if (data[i][0].toLowerCase() === username.toLowerCase()) {",
    "      return createResponse({ success: false, error: 'Username already exists' });",
    "    }",
    "  }",
    "  ",
    "  usersSheet.appendRow([username, hashPassword(password), false]);",
    "  return createResponse({ success: true, user: { username: username, isAdmin: false } });",
    "}",
    "",
    "function changePassword(username, oldPassword, newPassword) {",
    "  const ss = SpreadsheetApp.getActiveSpreadsheet();",
    "  const usersSheet = ss.getSheetByName(SHEET_USERS);",
    "  ",
    "  const data = usersSheet.getDataRange().getValues();",
    "  for (let i = 1; i < data.length; i++) {",
    "    if (data[i][0].toLowerCase() === username.toLowerCase()) {",
    "      const currentHash = data[i][1];",
    "      if (currentHash === hashPassword(oldPassword)) {",
    "        usersSheet.getRange(i + 1, 2).setValue(hashPassword(newPassword));",
    "        return createResponse({ success: true, message: 'Password updated' });",
    "      } else {",
    "        return createResponse({ success: false, error: 'Incorrect old password' });",
    "      }",
    "    }",
    "  }",
    "  return createResponse({ success: false, error: 'User not found' });",
    "}",
    "",
    "function getBets(sheet) {",
    "  const lastRow = sheet.getLastRow();",
    "  if (lastRow < 2) return createResponse({ success: true, data: [] });",
    "",
    "  // Read up to column 17 (Q) to include proposal fields",
    "  const data = sheet.getRange(2, 1, lastRow - 1, 17).getValues();",
    "  ",
    "  const rows = data.map((row, index) => {",
    "    return {",
    "      id: index,",
    "      Date: row[0],",
    "      Better1: row[1],",
    "      Better2: row[2],",
    "      Better1Bet: row[3],",
    "      Better2Bet: row[4],",
    "      Better1Reward: row[5],",
    "      Better2Reward: row[6],",
    "      WinnerLabel: row[7],",
    "      Status: row[8],",
    "      proposerWinner: row[13] || null,",
    "      proposedWinnerValue: row[14] || null,",
    "      proposerPaid: row[15] || null,",
    "      proposedPaidValue: row[16] || null",
    "    };",
    "  });",
    "  ",
    "  return createResponse({ success: true, data: rows });",
    "}",
    "",
    "function addBet(sheet, params, user) {",
    "  const better1 = params.better1;",
    "  const better2 = params.better2;",
    "  ",
    "  if (!user.isAdmin && user.username !== better1 && user.username !== better2) {",
    "    return createResponse({ success: false, error: 'You can only place bets for yourself' });",
    "  }",
    "",
    "  const date = new Date();",
    "  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];",
    "  const dateStr = date.getDate() + '-' + months[date.getMonth()] + '-' + date.getFullYear();",
    "  ",
    "  const newRow = [",
    "    dateStr,",
    "    better1 || '',",
    "    better2 || '',",
    "    params.better1Bet || '',",
    "    params.better2Bet || '',",
    "    '€' + parseFloat(params.better1Reward || 0).toFixed(2),",
    "    '€' + parseFloat(params.better2Reward || 0).toFixed(2),",
    "    '', // WinnerLabel",
    "    'Pending Confirmation', // Status",
    "    '', // WinnerName",
    "    '', // AmountWon",
    "    '', // LoserName",
    "    '', // AmountLost",
    "    '', // ProposerWinner",
    "    '', // ProposedWinnerValue",
    "    '', // ProposerPaid",
    "    ''  // ProposedPaidValue",
    "  ];",
    "  ",
    "  sheet.appendRow(newRow);",
    "  SpreadsheetApp.flush();",
    "  return createResponse({ success: true, message: 'Bet added' });",
    "}",
    "",
    "function updateBet(sheet, params, user) {",
    "  const rowIndex = parseInt(params.rowId) + 2;",
    "  const winnerKey = params.winner;",
    "  ",
    "  const rowRange = sheet.getRange(rowIndex, 1, 1, 17);",
    "  const rowValues = rowRange.getValues()[0];",
    "  ",
    "  const better1 = rowValues[1];",
    "  const better2 = rowValues[2];",
    "  ",
    "  if (!user.isAdmin && user.username !== better1 && user.username !== better2) {",
    "    return createResponse({ success: false, error: 'Only participants can update this bet' });",
    "  }",
    "  ",
    "  const existingProposer = rowValues[13];",
    "  const existingProposal = rowValues[14];",
    "  ",
    "  const isConceding = (winnerKey.toLowerCase() === 'better1' && user.username === better2) || ",
    "                      (winnerKey.toLowerCase() === 'better2' && user.username === better1);",
    "  ",
    "  if (user.isAdmin || isConceding || (existingProposer && existingProposer !== user.username && existingProposal === winnerKey)) {",
    "    const fullRow = rowValues;",
    "    let winnerName, loserName, amountWon, amountLost;",
    "   ",
    "    if (winnerKey === 'better1' || winnerKey === 'Better 1') {",
    "      winnerName = fullRow[1];",
    "      loserName = fullRow[2];",
    "      amountWon = fullRow[5];",
    "      amountLost = fullRow[6];",
    "    } else {",
    "      winnerName = fullRow[2];",
    "      loserName = fullRow[1];",
    "      amountWon = fullRow[6];",
    "      amountLost = fullRow[5];",
    "    }",
    "  ",
    "    const winnerLabel = (winnerKey === 'better1' || winnerKey === 'Better 1') ? 'Better 1' : 'Better 2';",
    "    ",
    "    sheet.getRange(rowIndex, 8).setValue(winnerLabel);",
    "    sheet.getRange(rowIndex, 9).setValue('Unpaid');",
    "    sheet.getRange(rowIndex, 10).setValue(winnerName);",
    "    sheet.getRange(rowIndex, 11).setValue(amountWon);",
    "    sheet.getRange(rowIndex, 12).setValue(loserName);",
    "    sheet.getRange(rowIndex, 13).setValue(amountLost);",
    "    ",
    "    sheet.getRange(rowIndex, 14).setValue('');",
    "    sheet.getRange(rowIndex, 15).setValue('');",
    "    ",
    "    SpreadsheetApp.flush();",
    "    return createResponse({ success: true, message: 'Winner confirmed!' });",
    "  } ",
    "  else {",
    "    sheet.getRange(rowIndex, 14).setValue(user.username);",
    "    sheet.getRange(rowIndex, 15).setValue(winnerKey);",
    "    SpreadsheetApp.flush();",
    "    return createResponse({ success: true, message: 'Winner proposed. Waiting for confirmation.' });",
    "  }",
    "}",
    "",
    "function markPaid(sheet, params, user) {",
    "  const rowIndex = parseInt(params.rowId) + 2;",
    "  const rowRange = sheet.getRange(rowIndex, 1, 1, 17);",
    "  const rowValues = rowRange.getValues()[0];",
    "  ",
    "  const better1 = rowValues[1];",
    "  const better2 = rowValues[2];",
    "  ",
    "  if (!user.isAdmin && user.username !== better1 && user.username !== better2) {",
    "    return createResponse({ success: false, error: 'Only participants can update this bet' });",
    "  }",
    "",
    "  const winnerName = rowValues[9];",
    "",
    "  if (user.username === winnerName) {",
    "    sheet.getRange(rowIndex, 9).setValue('Paid');",
    "    sheet.getRange(rowIndex, 16).setValue('');",
    "    sheet.getRange(rowIndex, 17).setValue('');",
    "    SpreadsheetApp.flush();",
    "    return createResponse({ success: true, message: 'Payment confirmed!' });",
    "  }",
    "",
    "  const existingProposer = rowValues[15];",
    "  const existingProposal = rowValues[16];",
    "",
    "  if (existingProposer && existingProposer !== user.username) {",
    "    sheet.getRange(rowIndex, 9).setValue('Paid'); ",
    "    sheet.getRange(rowIndex, 16).setValue('');",
    "    sheet.getRange(rowIndex, 17).setValue('');",
    "    SpreadsheetApp.flush();",
    "    return createResponse({ success: true, message: 'Payment confirmed!' });",
    "  } else {",
    "    sheet.getRange(rowIndex, 16).setValue(user.username);",
    "    sheet.getRange(rowIndex, 17).setValue('Paid');",
    "    SpreadsheetApp.flush();",
    "    return createResponse({ success: true, message: 'Payment marked. Waiting for winner to confirm receipt.' });",
    "  }",
    "}",
    "",
    "function getUsers() {",
    "  const ss = SpreadsheetApp.getActiveSpreadsheet();",
    "  const usersSheet = ss.getSheetByName(SHEET_USERS);",
    "  if (!usersSheet) return createResponse({ success: true, data: [] });",
    "  ",
    "  const data = usersSheet.getDataRange().getValues();",
    "  const users = data.slice(1)",
    "    .map(row => row[0])",
    "    .filter(name => name && name.toLowerCase() !== 'admin');",
    "    ",
    "  return createResponse({ success: true, data: users });",
    "}",
    "",
    "function confirmBet(sheet, params, user) {",
    "  const rowIndex = parseInt(params.rowId) + 2;",
    "  const confirmAction = params.confirmAction;",
    "  const rowRange = sheet.getRange(rowIndex, 1, 1, 17);",
    "  const rowValues = rowRange.getValues()[0];",
    "  const better2 = rowValues[2];",
    "  const currentStatus = rowValues[8];",
    "",
    "  if (currentStatus !== 'Pending Confirmation') {",
    "    return createResponse({ success: false, error: 'Bet is already processed' });",
    "  }",
    "",
    "  if (!user.isAdmin && user.username !== better2) {",
    "    return createResponse({ success: false, error: 'Only the opponent can confirm this bet' });",
    "  }",
    "",
    "  if (confirmAction === 'confirm') {",
    "    sheet.getRange(rowIndex, 9).setValue('');",
    "  } else {",
    "    sheet.deleteRow(rowIndex);",
    "  }",
    "",
    "  SpreadsheetApp.flush();",
    "  return createResponse({ success: true, message: 'Bet ' + confirmAction + 'ed' });",
    "}",
    "",
    "function createResponse(data) {",
    "  return ContentService.createTextOutput(JSON.stringify(data))",
    "    .setMimeType(ContentService.MimeType.JSON);",
    "}"
];

fs.writeFileSync(outputPath, lines.join('\\n'));
console.log('Successfully generated Code.gs at ' + outputPath);
console.log('Admin User: ' + adminUsername);
